<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>{{ stock.name }} ìƒì„¸ ì •ë³´</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* [ë‹¤í¬ ëª¨ë“œ ìŠ¤íƒ€ì¼ ì •ì˜] */
        :root {
            --bg-color: #1e1e1e;       /* ì „ì²´ ë°°ê²½ (ì§„í•œ íšŒìƒ‰) */
            --card-bg: #2d2d2d;        /* ë°•ìŠ¤ ë°°ê²½ (ì•½ê°„ ë°ì€ íšŒìƒ‰) */
            --text-main: #e0e0e0;      /* ë©”ì¸ ê¸€ì (í°ìƒ‰ì— ê°€ê¹Œìš´ íšŒìƒ‰) */
            --text-sub: #b0b0b0;       /* ë³´ì¡° ê¸€ì (íšŒìƒ‰) */
            --accent: #bb86fc;         /* ê°•ì¡°ìƒ‰ (ì—°í•œ ë³´ë¼) */
            --border: #444444;         /* í…Œë‘ë¦¬ ìƒ‰ */
            --table-head: #333333;     /* í‘œ í—¤ë” ë°°ê²½ */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 20px;
        }

        h1, h2, h3 { color: var(--text-main); }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-ai {
            background-color: #6200ea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background 0.3s;
        }
        .btn-ai:hover { background-color: #3700b3; }

        /* ì»¨í…Œì´ë„ˆ ë°•ìŠ¤ë“¤ (AI ê²°ê³¼ì°½ ë“±) */
        .box-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 12px;
            text-align: right; /* ìˆ«ìëŠ” ìš°ì¸¡ ì •ë ¬ */
            border-bottom: 1px solid var(--border);
        }
        th {
            background-color: var(--table-head);
            color: var(--accent);
            text-align: center;
        }
        tr:hover { background-color: #383838; }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        /* [ë¡œë”© ìŠ¤í”¼ë„ˆ ì˜¤ë²„ë ˆì´] */
        #loading-overlay {
            display: none; /* í‰ì†Œì—ëŠ” ìˆ¨ê¹€ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* ë°°ê²½ì„ ì–´ë‘¡ê²Œ */
            z-index: 9999; /* ëª¨ë“  ê²ƒ ìœ„ì— í‘œì‹œ */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(5px); /* ë°°ê²½ ë¸”ëŸ¬ íš¨ê³¼ ì¶”ê°€ */
        }

        /* ë±…ê¸€ë±…ê¸€ ë„ëŠ” ì› */
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid var(--accent); /* ë³´ë¼ìƒ‰ */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div style="max-width: 1000px; margin: 0 auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>ğŸ“ˆ {{ stock.name }} <span style="font-size: 0.6em; color: var(--text-sub);">({{ stock.code }})</span></h1>
            <a href="/stocks/" style="padding: 8px 16px; background: var(--card-bg); border-radius: 5px; border: 1px solid var(--border);">
                â¬…ï¸ ëª©ë¡ìœ¼ë¡œ
            </a>
        </div>

        <div class="chart-container">
            <canvas id="myChart"></canvas>
        </div>

        <div class="box-container">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                ğŸ¤– Gemini AI íˆ¬ì ë¶„ì„
            </h3>

            {% if ai_result %}
                <div style="line-height: 1.8; white-space: pre-wrap; color: var(--text-main);">{{ ai_result }}</div>
                <div style="margin-top: 15px; text-align: right;">
                    <a href="." style="font-size: 0.9em; color: var(--text-sub);">[ê²°ê³¼ ì§€ìš°ê¸°]</a>
                </div>
            {% else %}
                <p style="color: var(--text-sub);">ìµœê·¼ 30ì¼ ì£¼ê°€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ AIê°€ ì°¨íŠ¸ë¥¼ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.</p>
                <form method="post" onsubmit="showLoading()">
                    {% csrf_token %}
                    <button type="submit" name="analyze" value="true" class="btn-ai">
                        âœ¨ AI ë¶„ì„ ì‹¤í–‰í•˜ê¸°
                    </button>
                </form>
            {% endif %}
        </div>

        <h3>ğŸ“Š ì¼ë³„ ì‹œì„¸ (ìµœê·¼ 30ì¼)</h3>

        {% load humanize %}

        <table>
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ì¢…ê°€</th>
                    <th>ì „ì¼ë¹„</th>
                    <th>ì‹œê°€</th>
                    <th>ê³ ê°€</th>
                    <th>ì €ê°€</th>
                    <th>ê±°ë˜ëŸ‰</th>
                </tr>
            </thead>
            <tbody>
                {% for price in prices %}
                <tr>
                    <td style="text-align: center;">{{ price.date|date:"Y-m-d" }}</td>
                    <td style="font-weight: bold; color: #ff8a80;">{{ price.close_price|floatformat:0 }}</td>
                    <td>-</td>
                    <td>{{ price.open_price|intcomma }}</td>
                    <td>{{ price.high_price|intcomma }}</td>
                    <td>{{ price.low_price|intcomma }}</td>
                    <td>{{ price.volume|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">ğŸ¤– AIê°€ ì°¨íŠ¸ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
        <div style="color: #bbb; margin-top: 5px; font-size: 0.9em;">(ì•½ 5~10ì´ˆ ì†Œìš”ë©ë‹ˆë‹¤)</div>
    </div>

    <script>
        // 1. ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ date_list|safe }},
                datasets: [{
                    label: 'ì¢…ê°€ (Close)',
                    data: {{ price_list|safe }},
                    borderColor: '#bb86fc', // ê·¸ë˜í”„ ì„  ìƒ‰ìƒ (ë³´ë¼ìƒ‰)
                    backgroundColor: 'rgba(187, 134, 252, 0.1)',
                    borderWidth: 2,
                    pointRadius: 2,
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#e0e0e0' } // ë²”ë¡€ ê¸€ììƒ‰
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#b0b0b0' }, // Xì¶• ê¸€ììƒ‰
                        grid: { color: '#444' }      // Xì¶• ê²©ììƒ‰
                    },
                    y: {
                        ticks: { color: '#b0b0b0' }, // Yì¶• ê¸€ììƒ‰
                        grid: { color: '#444' }      // Yì¶• ê²©ììƒ‰
                    }
                }
            }
        });

        // [ì¶”ê°€ëœ ë¶€ë¶„] 2. ë¡œë”© í™”ë©´ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }
    </script>
</body>
</html>